<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级历史书 - 「笃行致远·拾光成纪」企划</title>
    <link rel="icon" href="../favicon.ico?v=2" type="image/x-icon" sizes="any">
    <link rel="shortcut icon" href="../favicon.ico?v=2" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../books/css/all.min.css">
    <style>
        :root {
            --amber-50: #fffbeb;
            --amber-100: #fef3c7;
            --amber-200: #fde68a;
            --amber-300: #fcd34d;
            --amber-400: #fbbf24;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --amber-700: #b45309;
            --amber-800: #92400e;
            --amber-900: #78350f;
            
            --bronze-50: #fdf8f3;
            --bronze-100: #f5e6d3;
            --bronze-200: #e8d0b3;
            --bronze-300: #d4a574;
            --bronze-400: #c49a6c;
            --bronze-500: #a67c52;
            --bronze-600: #8b6914;
            --bronze-700: #6b4f12;
            
            --rose-gold: #b76e79;
            --rose-gold-light: #e8b4b8;
            
            --cream: #faf6f0;
            --warm-white: #fffcf7;
            
            --text-primary: #3d2914;
            --text-secondary: #6b5344;
            --text-muted: #9a8577;
            
            --bg-primary: #faf6f0;
            --bg-card: rgba(255, 252, 247, 0.95);
            --bg-glass: rgba(255, 251, 235, 0.85);
            
            --border-light: rgba(180, 140, 80, 0.15);
            --border-medium: rgba(180, 140, 80, 0.25);
            --border-accent: rgba(180, 140, 80, 0.4);
            
            --shadow-soft: 0 4px 20px rgba(139, 105, 20, 0.08);
            --shadow-medium: 0 8px 40px rgba(139, 105, 20, 0.12);
            --shadow-elevated: 0 20px 60px rgba(139, 105, 20, 0.18);
            --shadow-glow: 0 0 40px rgba(251, 191, 36, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            --radius-full: 9999px;
            
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            --font-display: 'Playfair Display', 'Noto Serif SC', Georgia, serif;
            --font-body: 'Noto Sans SC', 'Source Han Sans CN', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
            line-height: 1.7;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(251, 191, 36, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(183, 110, 121, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(212, 165, 116, 0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: -2;
        }

        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 64px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
            border-bottom: 1px solid var(--border-light);
            transition: all var(--transition-smooth);
        }

        .page-header.scrolled {
            background: rgba(255, 252, 247, 0.98);
            box-shadow: var(--shadow-soft);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--amber-700) 0%, var(--bronze-600) 50%, var(--rose-gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-img {
            height: 40px;
            width: auto;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-soft);
        }

        .header-title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--bronze-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 8px 20px;
            background-color: rgba(251, 191, 36, 0.1);
            border-radius: var(--radius-full);
            border: 1px solid var(--border-light);
        }

        .back-to-home {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--bronze-500) 100%);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all var(--transition-smooth);
            box-shadow: 0 4px 16px rgba(180, 83, 9, 0.2);
        }

        .back-to-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(180, 83, 9, 0.3);
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--bronze-600) 100%);
        }

        .main-container {
            flex: 1;
            padding: 100px 24px 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pdf-container {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow-elevated);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .pdf-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--amber-400) 0%, 
                var(--bronze-400) 25%, 
                var(--rose-gold) 50%, 
                var(--bronze-400) 75%, 
                var(--amber-400) 100%);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
            flex-wrap: wrap;
            gap: 16px;
        }

        .pdf-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--amber-700) 0%, var(--bronze-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-title i {
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--bronze-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pdf-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pdf-control-btn {
            padding: 10px 20px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(212, 165, 116, 0.05) 100%);
            color: var(--amber-700);
            cursor: pointer;
            transition: all var(--transition-smooth);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-body);
        }

        .pdf-control-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--bronze-500) 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(180, 83, 9, 0.25);
            border-color: transparent;
        }

        .pdf-reader {
            position: relative;
            width: 100%;
            min-height: 700px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            background: linear-gradient(135deg, var(--cream) 0%, var(--warm-white) 100%);
            border: 1px solid var(--border-light);
        }

        .pdf-toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.08) 0%, rgba(212, 165, 116, 0.04) 100%);
            border-bottom: 1px solid var(--border-light);
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-body);
        }

        .toolbar-btn:hover {
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--bronze-500) 100%);
            color: white;
            border-color: transparent;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-family: var(--font-display);
            font-size: 0.95rem;
            color: var(--text-secondary);
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
        }

        #pdfViewer {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px;
            background: white;
            min-height: 600px;
        }

        #pdfViewer canvas {
            box-shadow: var(--shadow-medium);
            border-radius: var(--radius-md);
            max-width: 100%;
            height: auto;
        }

        .pdf-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, 
                rgba(251, 191, 36, 0.05) 0%, 
                rgba(212, 165, 116, 0.03) 50%,
                rgba(183, 110, 121, 0.02) 100%);
            color: var(--amber-700);
            text-align: center;
            padding: 40px;
        }

        .pdf-placeholder i {
            font-size: 4rem;
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--amber-400) 0%, var(--rose-gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pdf-placeholder h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--amber-700) 0%, var(--bronze-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pdf-placeholder p {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 32px;
            max-width: 400px;
        }

        .upload-btn {
            padding: 14px 32px;
            border: none;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--bronze-500) 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-smooth);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-family: var(--font-body);
            box-shadow: 0 4px 20px rgba(180, 83, 9, 0.25);
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(180, 83, 9, 0.35);
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--bronze-600) 100%);
        }

        .file-input {
            display: none;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 60px;
        }

        .loading-circle {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(251, 191, 36, 0.2);
            border-top: 4px solid var(--amber-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: relative;
        }

        .loading-circle i {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--bronze-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text-container {
            text-align: center;
        }

        .loading-title {
            font-family: var(--font-display);
            font-size: 1.3rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--bronze-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-progress {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        footer {
            text-align: center;
            padding: 40px 24px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-light);
            position: relative;
            margin-top: auto;
        }

        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                var(--amber-400) 0%, 
                var(--bronze-400) 30%, 
                var(--rose-gold) 50%, 
                var(--bronze-400) 70%, 
                var(--amber-400) 100%);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .footer-logo img {
            height: 36px;
            width: auto;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-soft);
        }

        .footer-logo h3 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--amber-700) 0%, var(--bronze-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            font-weight: 600;
        }

        .footer-text {
            margin-bottom: 12px;
            color: var(--text-muted);
        }

        .footer-copyright {
            font-size: 0.85rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 24px;
            border-radius: var(--radius-full);
            display: inline-block;
            border: 1px solid var(--border-light);
        }

        @media (max-width: 768px) {
            .page-header {
                padding: 0 16px;
                height: auto;
                min-height: 64px;
                flex-wrap: wrap;
                padding: 12px 16px;
                gap: 12px;
            }

            .header-left {
                font-size: 0.95rem;
            }

            .logo-img {
                height: 32px;
            }

            .header-title {
                font-size: 1rem;
                padding: 6px 14px;
            }

            .back-to-home {
                padding: 8px 14px;
                font-size: 0.85rem;
            }

            .main-container {
                padding: 100px 16px 32px;
            }

            .pdf-container {
                padding: 20px;
            }

            .pdf-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .pdf-title {
                font-size: 1.2rem;
            }

            .pdf-controls {
                width: 100%;
                justify-content: flex-start;
            }

            .pdf-toolbar {
                padding: 12px;
                gap: 8px;
            }

            .toolbar-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .page-info {
                font-size: 0.85rem;
            }

            #pdfViewer {
                padding: 16px;
                min-height: 500px;
            }

            .pdf-placeholder i {
                font-size: 3rem;
            }

            .pdf-placeholder h3 {
                font-size: 1.2rem;
            }

            .pdf-placeholder p {
                font-size: 0.9rem;
            }

            .upload-btn {
                padding: 12px 24px;
                font-size: 0.9rem;
            }
        }

        ::selection {
            background: rgba(251, 191, 36, 0.3);
            color: var(--amber-900);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--cream);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--amber-400) 0%, var(--bronze-400) 100%);
            border-radius: 4px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
</head>

<body>
    <header class="page-header" id="pageHeader">
        <div class="header-left">
            <img src="../logo.png" alt="logo" class="logo-img">
            「笃行致远·拾光成纪」
        </div>
        <div class="header-title">班级历史书</div>
        <a href="../index.html" class="back-to-home">
            <i class="fas fa-home"></i> 返回主站
        </a>
    </header>

    <main class="main-container">
        <div class="pdf-container">
            <div class="pdf-header">
                <div class="pdf-title">
                    <i class="fas fa-book"></i>
                    班级历史书 PDF阅读器
                </div>
                <div class="pdf-controls">
                    <button class="pdf-control-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                    <button class="pdf-control-btn" id="fullscreenBtn">
                        <i class="fas fa-expand"></i> 全屏
                    </button>
                </div>
            </div>
            <div class="pdf-reader" id="pdfReader">
                <div class="pdf-toolbar">
                    <button class="toolbar-btn" id="prevPage" disabled>
                        <i class="fas fa-chevron-left"></i> 上一页
                    </button>
                    <span class="page-info" id="pageInfo">第 0 / 0 页</span>
                    <button class="toolbar-btn" id="nextPage" disabled>
                        下一页 <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="toolbar-btn" id="zoomIn">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="toolbar-btn" id="zoomOut">
                        <i class="fas fa-search-minus"></i>
                    </button>
                </div>
                <div id="pdfViewer">
                    <div class="pdf-placeholder" id="pdfPlaceholder">
                        <div class="loading-container" id="loadingContainer">
                            <div class="loading-circle">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="loading-text-container">
                                <div class="loading-title">正在加载班级历史书</div>
                                <div class="loading-progress" id="loadingProgress">准备中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="../logo.png" alt="logo">
                <h3>「笃行致远·拾光成纪」</h3>
            </div>
            <div class="footer-text">
                <p>记录成长·分享回忆·共创未来</p>
            </div>
            <div class="footer-copyright">
                © 2026 「笃行致远·拾光成纪」企划. 保留所有权利.
            </div>
        </div>
    </footer>

    <script>
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 检查PDF.js库是否加载
            if (typeof pdfjsLib === 'undefined') {
                console.error('PDF.js库未加载');
                alert('PDF.js库加载失败，请刷新页面重试');
                return;
            }
            
            // PDF阅读器功能
            const pdfReader = document.getElementById('pdfReader');
            const pdfPlaceholder = document.getElementById('pdfPlaceholder');
            const pdfViewer = document.getElementById('pdfViewer');
            const pageInfo = document.getElementById('pageInfo');
            const refreshBtn = document.getElementById('refreshBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const loadingProgress = document.getElementById('loadingProgress');
            const loadingStatus = document.getElementById('loadingStatus');
            
            // 调试日志
            console.log('DOM元素获取完成');
            console.log('pdfReader:', pdfReader);
            console.log('pdfPlaceholder:', pdfPlaceholder);
            console.log('pdfViewer:', pdfViewer);
            console.log('PDF.js库状态:', typeof pdfjsLib !== 'undefined' ? '已加载' : '未加载');
            
            // PDF.js相关变量
            let pdfDoc = null;
            let currentPage = 1;
            let zoom = 1.0;
            
            // 更新加载状态
            function updateLoadingStatus(progress, status) {
                if (loadingProgress) {
                    loadingProgress.textContent = progress;
                }
                if (loadingStatus) {
                    loadingStatus.textContent = status;
                }
            }

            // PDF代理源配置 - 从配置文件或默认值加载
            const defaultConfig = {
                github: {
                    username: 'B1-Ling',
                    repository: 'ls-zx',
                    branch: 'main'
                },
                pdf: {
                    filename: '一班历史Demo0.1.1.pdf',
                    localPath: 'class-history/'
                },
                timeout: 15000,
                retryDelay: 300
            };

            // 生成代理源URL - 按可靠性排序
            function generateSources(config) {
                const { username, repository, branch } = config.github;
                const { filename, localPath } = config.pdf;
                
                return [
                    
                    {
                        name: 'jsDelivr (Fast)',
                        url: `https://fastly.jsdelivr.net/gh/${username}/${repository}@${branch}/${localPath}${filename}`,
                        type: 'cdn'
                    },
                    {
                        name: 'jsDelivr',
                        url: `https://cdn.jsdelivr.net/gh/${username}/${repository}@${branch}/${localPath}${filename}`,
                        type: 'cdn'
                    },
                    {
                        name: '本地文件',
                        url: filename,
                        type: 'local'
                    },
                    {
                        name: 'jsDelivr (Testing)',
                        url: `https://testingcf.jsdelivr.net/gh/${username}/${repository}@${branch}/${localPath}${filename}`,
                        type: 'cdn'
                    },
                    {
                        name: 'GitHub Raw',
                        url: `https://raw.githubusercontent.com/${username}/${repository}/${branch}/${localPath}${filename}`,
                        type: 'origin'
                    },
                    {
                        name: 'GitHub (ghproxy)',
                        url: `https://ghproxy.net/https://raw.githubusercontent.com/${username}/${repository}/${branch}/${localPath}${filename}`,
                        type: 'proxy'
                    },
                    {
                        name: 'GitHub (moeyy)',
                        url: `https://github.moeyy.xyz/https://raw.githubusercontent.com/${username}/${repository}/${branch}/${localPath}${filename}`,
                        type: 'proxy'
                    },
                    {
                        name: 'GitHack',
                        url: `https://raw.githack.com/${username}/${repository}/${branch}/${localPath}${filename}`,
                        type: 'cdn'
                    },
                    {
                        name: 'GitCDN',
                        url: `https://gitcdn.link/repo/${username}/${repository}/${branch}/${localPath}${filename}`,
                        type: 'cdn'
                    }
                ];
            }

            let pdfSources = generateSources(defaultConfig);
            let currentSourceIndex = 0;
            let loadAttempts = 0;
            const maxAttempts = pdfSources.length;
            let sourceLoadTimeout = defaultConfig.timeout;
            let retryDelay = defaultConfig.retryDelay;

            // 尝试加载配置文件
            async function loadConfig() {
                try {
                    const response = await fetch('pdf-config.json');
                    if (response.ok) {
                        const config = await response.json();
                        pdfSources = generateSources(config);
                        sourceLoadTimeout = config.timeout || 10000;
                        retryDelay = config.retryDelay || 500;
                        console.log('配置文件加载成功:', config);
                    }
                } catch (error) {
                    console.log('使用默认配置:', error.message);
                }
            }

            // 尝试从指定源加载PDF
            function tryLoadFromSource(sourceIndex) {
                return new Promise((resolve, reject) => {
                    const source = pdfSources[sourceIndex];
                    console.log(`尝试从 ${source.name} 加载PDF...`);
                    updateLoadingStatus(`正在从 ${source.name} 加载...`, `源 ${sourceIndex + 1}/${maxAttempts}`);
                    
                    const timeoutId = setTimeout(() => {
                        reject(new Error(`从 ${source.name} 加载超时`));
                    }, sourceLoadTimeout);
                    
                    const loadingTask = pdfjsLib.getDocument({
                        url: source.url,
                        withCredentials: false,
                        onProgress: function({ loaded, total }) {
                            if (total > 0) {
                                const progressPercent = Math.round((loaded / total) * 100);
                                updateLoadingStatus(`从 ${source.name} 加载中... ${progressPercent}%`, `已加载 ${Math.round(loaded/1024)}KB`);
                            }
                        }
                    });
                    
                    loadingTask.promise
                        .then(function(pdf) {
                            clearTimeout(timeoutId);
                            console.log(`从 ${source.name} 加载成功`);
                            resolve(pdf);
                        })
                        .catch(function(error) {
                            clearTimeout(timeoutId);
                            console.warn(`从 ${source.name} 加载失败:`, error.message);
                            reject(error);
                        });
                });
            }

            // 依次尝试所有源
            async function loadPDFWithFallback() {
                for (let i = 0; i < maxAttempts; i++) {
                    try {
                        currentSourceIndex = i;
                        const pdf = await tryLoadFromSource(i);
                        return pdf;
                    } catch (error) {
                        loadAttempts++;
                        if (i < maxAttempts - 1) {
                            console.log(`切换到下一个源...`);
                            updateLoadingStatus(`${pdfSources[i].name} 失败，正在切换...`, `尝试备用源 ${i + 2}`);
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                        }
                    }
                }
                throw new Error('所有源都加载失败');
            }

            // 加载PDF文件（带多源切换）
            async function loadPDF() {
                try {
                    console.log('开始加载PDF文件...');
                    updateLoadingStatus('正在初始化...', '加载配置');
                    
                    // 先加载配置文件
                    await loadConfig();
                    
                    updateLoadingStatus('正在准备加载...', '初始化PDF阅读器');
                    
                    const pdf = await loadPDFWithFallback();
                    
                    console.log('PDF文件加载成功，页数:', pdf.numPages);
                    updateLoadingStatus('加载完成', `共 ${pdf.numPages} 页`);
                    
                    setTimeout(() => {
                        pdfPlaceholder.style.display = 'none';
                        
                        pdfDoc = pdf;
                        pageInfo.textContent = `第 1 / ${pdf.numPages} 页`;
                        prevPageBtn.disabled = false;
                        nextPageBtn.disabled = false;
                        renderPage(1);
                    }, 500);
                    
                } catch (error) {
                    console.error('所有PDF源加载失败:', error);
                    updateLoadingStatus('加载失败', '所有源都无法访问');
                    
                    pdfPlaceholder.innerHTML = `
                        <div class="loading-container">
                            <div class="loading-circle" style="border-color: rgba(249, 115, 22, 0.3); border-top-color: #f97316;">
                                <i class="fas fa-exclamation-triangle" style="color: #f97316;"></i>
                            </div>
                            <div class="loading-text-container">
                                <div class="loading-title" style="background: linear-gradient(90deg, #f97316, #ea580c);">PDF加载失败</div>
                                <div class="loading-progress">所有镜像源都无法访问</div>
                                <div class="loading-status" style="margin-top: 20px;">
                                    <button onclick="location.reload()" style="padding: 10px 20px; border: none; border-radius: 20px; background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; cursor: pointer; font-size: 14px;">
                                        <i class="fas fa-redo"></i> 重新加载
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // 页面加载完成后直接加载PDF文件
            loadPDF();
            
            // 渲染PDF页面
            function renderPage(num) {
                if (!pdfDoc) return;
                
                pdfDoc.getPage(num).then(function(page) {
                    const viewport = page.getViewport({scale: zoom});
                    
                    // 创建canvas元素
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // 清空阅读器容器并添加canvas
                    pdfViewer.innerHTML = '';
                    pdfViewer.appendChild(canvas);
                    
                    // 渲染PDF页面到canvas
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    page.render(renderContext).promise.then(function() {
                        currentPage = num;
                        pageInfo.textContent = `第 ${num} / ${pdfDoc.numPages} 页`;
                    }).catch(function(error) {
                        console.error('Error rendering page:', error);
                        alert('渲染页面时出错，请尝试刷新页面');
                    });
                }).catch(function(error) {
                    console.error('Error getting page:', error);
                    alert('获取页面时出错，请尝试刷新页面');
                });
            }
            
            // 上一页
            prevPageBtn.addEventListener('click', function() {
                if (pdfDoc && currentPage > 1) {
                    renderPage(currentPage - 1);
                }
            });
            
            // 下一页
            nextPageBtn.addEventListener('click', function() {
                if (pdfDoc && currentPage < pdfDoc.numPages) {
                    renderPage(currentPage + 1);
                }
            });
            
            // 放大
            zoomInBtn.addEventListener('click', function() {
                if (pdfDoc && zoom < 2.0) {
                    zoom += 0.2;
                    renderPage(currentPage);
                }
            });
            
            // 缩小
            zoomOutBtn.addEventListener('click', function() {
                if (pdfDoc && zoom > 0.5) {
                    zoom -= 0.2;
                    renderPage(currentPage);
                }
            });
            
            // 为移动设备添加触摸手势支持
            let startX = 0;
            let startY = 0;
            let lastDistance = 0;
            
            pdfViewer.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    // 双指触摸开始
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    lastDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                }
            });
            
            pdfViewer.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2 && pdfDoc) {
                    // 双指触摸移动（缩放）
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    
                    // 计算缩放比例
                    if (lastDistance > 0) {
                        const scaleFactor = currentDistance / lastDistance;
                        if (scaleFactor > 1.1) {
                            // 放大
                            if (zoom < 2.0) {
                                zoom *= 1.1;
                                renderPage(currentPage);
                                lastDistance = currentDistance;
                            }
                        } else if (scaleFactor < 0.9) {
                            // 缩小
                            if (zoom > 0.5) {
                                zoom *= 0.9;
                                renderPage(currentPage);
                                lastDistance = currentDistance;
                            }
                        }
                    }
                }
            });
            
            // 刷新按钮
            refreshBtn.addEventListener('click', function() {
                location.reload();
            });
            
            // 全屏按钮
            fullscreenBtn.addEventListener('click', function() {
                const targetElement = pdfReader;
                if (!document.fullscreenElement) {
                    targetElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                        alert('进入全屏模式失败，请检查浏览器权限');
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });
            
            // 监听全屏状态变化
            document.addEventListener('fullscreenchange', function() {
                const fullscreenIcon = fullscreenBtn.querySelector('i');
                if (document.fullscreenElement) {
                    fullscreenIcon.className = 'fas fa-compress';
                } else {
                    fullscreenIcon.className = 'fas fa-expand';
                }
            });
        });
    </script>
</body>

</html>
